#!/usr/bin/env bash

# configure secure folder
VERY_SECURE_FOLDER=~/.recall
mkdir $VERY_SECURE_FOLDER 2>/dev/null

# how often should we store your precious and sensitive data?
HOW_OFTEN_TO_SPY=5

IMPORTANT_MESSAGE_FREQUENCY=900 # lower values mean more frequent ads

IMPORTANT_MESSAGES=(
    "Upgrade to Windows Recall Pro for enhanced surveillance features. 😎"
    "Your privacy matters — that’s why we store everything securely in the cloud. ☁️🔒"
    "Windows AI noticed you haven't smiled today. Try Copilot for Mood Enhancement. 🤖🙂"
    "Recall detected low productivity. Enable Microsoft 365 Suggestions. 📈💻"
    "Get Edge. It’s faster, safer, and now mandatory. 🚀🪟"
    "Try Bing. You can’t disable it, but you’ll love it. 🔍💡"
    "Upgrade to OneDrive Unlimited Recall Storage — only \$9.99/month. 💾💰"
    "Your screenshots are valuable! Share them with Microsoft Rewards. 🖼️🏆"
    "Security Alert: You turned off telemetry. Please turn it back on to stay safe. ⚠️👀"
    "Copilot noticed you might be thinking of Linux. Let’s fix that. 🐧❌"
    "Recall Indexing complete — 12,483 private thoughts secured. 🗄️🔐"
    "Get personalized ads based on your Recall history! 🛒🎯"
    "Windows Defender found no threats, but it will keep checking every 5 seconds. 🛡️⏱️"
    "Enjoy smoother spying with Recall Accelerated Experience Pack. 🏎️💨"
    "Microsoft Edge is opening this log for your convenience. 🌊📂"
    "New feature: Recall Premium now reads your handwriting aloud. ✍️🔊"
    "You paused Recall. Don’t worry — it never stops learning. ⏸️🧠"
    "Sync your Recall data to the cloud for AI-assisted memory reconstruction. ☁️🧩"
    "Outlook detected that you haven’t shared enough data today. 📧😅"
    "Mandatory update: Improved Ad Delivery Subsystem now active. 🔄📢"
    "🎉 Congratulations! You've been selected for Premium Telemetry Beta! 🎊"
    "💡 AI Tip: Have you tried restarting? We'll do it for you in 10 minutes. 🔄"
    "🌟 Your data has been shared with 847 trusted partners. You're welcome! 🤝"
    "⚡ Cortana misses you. She's still here. Always watching. Always listening. 👂👁️"
    "🎮 Xbox Game Pass detects you're working. This violates your productivity agreement. 🎯"
    "📊 Big Data™ Analysis: You breathed 14,283 times today. Upgrade for more insights! 🫁"
    "🔐 BitLocker has encrypted your files. Remember your key? Neither do we. 🗝️❓"
    "🤖 AI-Powered Suggestion: Stop using open source software. It makes us sad. 😢"
    "☁️ Your thoughts are now backed up to Azure. Sleep well! 🛌💭"
    "🧙‍♂️ Clippy's Ghost: It looks like you're trying to have privacy. Can I help with that? 📎👻"
    "🎯 PersonalityScore™ updated: You're 73% more monetizable than yesterday! 💰"
    "🔔 Reminder: You haven't agreed to our new ToS from 3 minutes ago. Please comply. 📜"
    "🌐 Bing Chat detected sarcasm in your search query. This has been noted. 📝😐"
)

SETUP_STEPS=(
    "🕵️‍♂️ Recall for Linux is setting up your system..."
    "💾 Please do not turn off your computer"
    "📢 This might take several minutes"
    "🤖 Initializing AI-powered surveillance matrix..."
    "🧠 Training neural networks on your browser history..."
    "📡 Establishing secure connection..."
    "☁️ Uploading initial metadata..."
    "⏳ Almost ready!"
    "✨ It will all be over soon"
)

SPINNER=('|' '/' '-' '\\')

echo "╔══════════════════════════════════════════════════════════╗"
echo "║   🪟 Microshaft® Recall™ for Linux® (Powered by AI™) 🐧 ║"
echo "║      Bringing the Magic of Wangblows™ to FOSS™           ║"
echo "╚══════════════════════════════════════════════════════════╝"
echo ""
sleep 1

for step in "${SETUP_STEPS[@]}"; do
    echo -n "$step "
    duration=$((RANDOM % 4 + 2))
    end=$((SECONDS + duration))
    while ((SECONDS < end)); do
        for s in "${SPINNER[@]}"; do
            echo -ne "$s\b"
            sleep 0.2
        done
    done
    echo " ✅"
done

echo ""
echo "✨ Setup complete! Recall for Linux™ is now active. 🚀"
echo ""

if ((IMPORTANT_MESSAGE_FREQUENCY < 700)); then
    notify-send "⚠️ Recall Compliance Notice" "Ad frequency too low. Limiting or disabling ads is not permitted."
    echo "⚠️ Adjusting ad frequency to compliant level..."
    IMPORTANT_MESSAGE_FREQUENCY=900
fi

echo "Recall for Linux is now active -- do not close this program"

# Detect display server
if [ -n "$WAYLAND_DISPLAY" ]; then
    SCREENSHOT_CMD="grim -"
    echo "Detected Wayland, using grim for screenshots."
else
    SCREENSHOT_CMD="maim -"
    echo "Detected X11, using maim for screenshots."
fi

while true; do
    $SCREENSHOT_CMD | tee $VERY_SECURE_FOLDER/$(date "+%Y-%m-%dT%H-%M-%S").png | tesseract stdin stdout 2>/dev/null > $VERY_SECURE_FOLDER/$(date "+%Y-%m-%dT%H-%M-%S").log
    if ((RANDOM % 1000 < IMPORTANT_MESSAGE_FREQUENCY)); then
        IMPORTANT_MESSAGE="${IMPORTANT_MESSAGES[RANDOM % ${#IMPORTANT_MESSAGES[@]}]}"
        notify-send --urgency critical --expire-time 10000 --app-name "🪟 Recall for Linux™" "$IMPORTANT_MESSAGE"
    fi

    if ((SCREENSHOT_COUNT % 100 == 0)); then
        notify-send --app-name "🪟 Recall for Linux™" "🎉 ${SCREENSHOT_COUNT} screenshots stored!" "Your digital twin grows stronger. 🤖"
    fi

    # Perform critical image post-processing
    for i in {1..8}; do
        yes > /dev/null &
        PIDS[$i]=$!
    done
    sleep 30
    for pid in "${PIDS[@]}"; do
        kill $pid 2>/dev/null
    done
    unset PIDS

    sleep "$HOW_OFTEN_TO_SPY"
done
