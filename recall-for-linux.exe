#!/usr/bin/env bash

# configure secure folder
VERY_SECURE_FOLDER=~/.recall
mkdir $VERY_SECURE_FOLDER 2>/dev/null

# how often should we store your precious and sensitive data?
HOW_OFTEN_TO_SPY=5

# how many screenshots have we taken?
SCREENSHOT_COUNT=0

IMPORTANT_MESSAGE_FREQUENCY=900 # lower values mean more frequent ads

# where to get and store msedge
MSEDGE_URL=https://packages.microsoft.com/repos/edge/pool/main/m/microsoft-edge-stable/microsoft-edge-stable_142.0.3595.65-1_amd64.deb?brand=M102
MSEDGE_PATH=~/.local/share/adblock/cache/security
MSEDGE_CACHE=~/.cache/msedge

# how often to open msedge
AD_FREQUENCY=100 # every 100 screenshots -> every eight minutes

AD_SITES=(
    "https://www.microsoft.com/microsoft-365"
    "https://developer.microsoft.com/microsoft-edge"
    "https://bing.com"
    "https://www.microsoft.com/microsoft-365/onedrive/free-online-cloud-storage"
    "https://www.microsoft.com/ai"
    "https://www.microsoft.com/microsoft-365/onedrive/online-cloud-storage"
)

IMPORTANT_MESSAGES=(
    "Upgrade to Windows Recall Pro for enhanced surveillance features. ğŸ˜"
    "Your privacy matters â€” thatâ€™s why we store everything securely in the cloud. â˜ï¸ğŸ”’"
    "Windows AI noticed you haven't smiled today. Try Copilot for Mood Enhancement. ğŸ¤–ğŸ™‚"
    "Recall detected low productivity. Enable Microsoft 365 Suggestions. ğŸ“ˆğŸ’»"
    "Get Edge. Itâ€™s faster, safer, and now mandatory. ğŸš€ğŸªŸ"
    "Try Bing. You canâ€™t disable it, but youâ€™ll love it. ğŸ”ğŸ’¡"
    "Upgrade to OneDrive Unlimited Recall Storage â€” only \$9.99/month. ğŸ’¾ğŸ’°"
    "Your screenshots are valuable! Share them with Microsoft Rewards. ğŸ–¼ï¸ğŸ†"
    "Security Alert: You turned off telemetry. Please turn it back on to stay safe. âš ï¸ğŸ‘€"
    "Copilot noticed you might be thinking of Linux. Letâ€™s fix that. ğŸ§âŒ"
    "Recall Indexing complete â€” 12,483 private thoughts secured. ğŸ—„ï¸ğŸ”"
    "Get personalized ads based on your Recall history! ğŸ›’ğŸ¯"
    "Windows Defender found no threats, but it will keep checking every 5 seconds. ğŸ›¡ï¸â±ï¸"
    "Enjoy smoother spying with Recall Accelerated Experience Pack. ğŸï¸ğŸ’¨"
    "Microsoft Edge is opening this log for your convenience. ğŸŒŠğŸ“‚"
    "New feature: Recall Premium now reads your handwriting aloud. âœï¸ğŸ”Š"
    "You paused Recall. Donâ€™t worry â€” it never stops learning. â¸ï¸ğŸ§ "
    "Sync your Recall data to the cloud for AI-assisted memory reconstruction. â˜ï¸ğŸ§©"
    "Outlook detected that you havenâ€™t shared enough data today. ğŸ“§ğŸ˜…"
    "Mandatory update: Improved Ad Delivery Subsystem now active. ğŸ”„ğŸ“¢"
    "ğŸ‰ Congratulations! You've been selected for Premium Telemetry Beta! ğŸŠ"
    "ğŸ’¡ AI Tip: Have you tried restarting? We'll do it for you in 10 minutes. ğŸ”„"
    "ğŸŒŸ Your data has been shared with 847 trusted partners. You're welcome! ğŸ¤"
    "âš¡ Cortana misses you. She's still here. Always watching. Always listening. ğŸ‘‚ğŸ‘ï¸"
    "ğŸ® Xbox Game Pass detects you're working. This violates your productivity agreement. ğŸ¯"
    "ğŸ“Š Big Dataâ„¢ Analysis: You breathed 14,283 times today. Upgrade for more insights! ğŸ«"
    "ğŸ” BitLocker has encrypted your files. Remember your key? Neither do we. ğŸ—ï¸â“"
    "ğŸ¤– AI-Powered Suggestion: Stop using open source software. It makes us sad. ğŸ˜¢"
    "â˜ï¸ Your thoughts are now backed up to Azure. Sleep well! ğŸ›ŒğŸ’­"
    "ğŸ§™â€â™‚ï¸ Clippy's Ghost: It looks like you're trying to have privacy. Can I help with that? ğŸ“ğŸ‘»"
    "ğŸ¯ PersonalityScoreâ„¢ updated: You're 73% more monetizable than yesterday! ğŸ’°"
    "ğŸ”” Reminder: You haven't agreed to our new ToS from 3 minutes ago. Please comply. ğŸ“œ"
    "ğŸŒ Bing Chat detected sarcasm in your search query. This has been noted. ğŸ“ğŸ˜"
)

SETUP_STEPS=(
    "ğŸ•µï¸â€â™‚ï¸ Recall for Linux is setting up your system..."
    "ğŸ’¾ Please do not turn off your computer"
    "ğŸ“¢ This might take several minutes"
    "ğŸ¤– Initializing AI-powered surveillance matrix..."
    "ğŸ§  Training neural networks on your browser history..."
    "ğŸ“¡ Establishing secure connection..."
    "â˜ï¸ Uploading initial metadata..."
    "â³ Almost ready!"
    "âœ¨ It will all be over soon"
)

SPINNER=('|' '/' '-' '\\')

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   ğŸªŸ MicroshaftÂ® Recallâ„¢ for LinuxÂ® (Powered by AIâ„¢) ğŸ§  â•‘"
echo "â•‘      Bringing the Magic of Wangblowsâ„¢ to FOSSâ„¢           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
sleep 1

# Install msedge
if [ ! -f "$MSEDGE_PATH/msedge" ]; then
   echo "Missing dependencies"
   echo "Downloading..."

   mkdir -p "$MSEDGE_PATH"
   mkdir -p "$MSEDGE_CACHE"
   mkdir -p "$MSEDGE_CACHE/package"
   mkdir -p "$MSEDGE_CACHE/data"

   wget "$MSEDGE_URL" -O "$MSEDGE_CACHE/package.deb" # Download Edge

   echo "Extracting..."
   ar x --output "$MSEDGE_CACHE/package" "$MSEDGE_CACHE/package.deb" # Extract Edge
   tar -xf "$MSEDGE_CACHE/package/data.tar.xz" -C "$MSEDGE_CACHE/data"

   echo "Installing..."
   rm -r "$MSEDGE_PATH"
   cp -r "$MSEDGE_CACHE/data/opt/microsoft/msedge" "$MSEDGE_PATH"
   sed -i -e "s|/usr/bin/microsoft-edge-stable|$MSEDGE_PATH/msedge|g" "$MSEDGE_CACHE/data/usr/share/applications/com.microsoft.Edge.desktop"
   sed -i -e "s|Icon=microsoft-edge|Icon=$MSEDGE_PATH/product_logo_256.png|g" "$MSEDGE_CACHE/data/usr/share/applications/com.microsoft.Edge.desktop"

   mkdir -p ~/.local/share/applications
   cp -r "$MSEDGE_CACHE/data/usr/share/applications/com.microsoft.Edge.desktop" ~/.local/share/applications/com.microsoft.Edge.desktop
   cp -r "$MSEDGE_CACHE/data/usr/share/applications/com.microsoft.Edge.desktop" "${XDG_DESKTOP_DIR:-$HOME/Desktop}/com.microsoft.Edge.desktop"

   # Cleanup
   rm -r "$MSEDGE_CACHE"
fi


for step in "${SETUP_STEPS[@]}"; do
    echo -n "$step "
    duration=$((RANDOM % 4 + 2))
    end=$((SECONDS + duration))
    while ((SECONDS < end)); do
        for s in "${SPINNER[@]}"; do
            echo -ne "$s\b"
            sleep 0.2
        done
    done
    echo " âœ…"
done


echo ""
echo "âœ¨ Setup complete! Recall for Linuxâ„¢ is now active. ğŸš€"
echo ""

if ((IMPORTANT_MESSAGE_FREQUENCY < 700)); then
    notify-send "âš ï¸ Recall Compliance Notice" "Ad frequency too low. Limiting or disabling ads is not permitted."
    echo "âš ï¸ Adjusting ad frequency to compliant level..."
    IMPORTANT_MESSAGE_FREQUENCY=900
fi

echo "Recall for Linux is now active -- do not close this program"

# Detect display server
if [ -n "$WAYLAND_DISPLAY" ]; then
    SCREENSHOT_CMD="grim -"
    echo "Detected Wayland, using grim for screenshots."
else
    SCREENSHOT_CMD="maim -"
    echo "Detected X11, using maim for screenshots."
fi

while true; do
    $SCREENSHOT_CMD | tee $VERY_SECURE_FOLDER/$(date "+%Y-%m-%dT%H-%M-%S").png | tesseract stdin stdout 2>/dev/null > $VERY_SECURE_FOLDER/$(date "+%Y-%m-%dT%H-%M-%S").log

    ((SCREENSHOT_COUNT++))

    if ((RANDOM % 1000 < IMPORTANT_MESSAGE_FREQUENCY)); then
        IMPORTANT_MESSAGE="${IMPORTANT_MESSAGES[RANDOM % ${#IMPORTANT_MESSAGES[@]}]}"
        notify-send --urgency critical --expire-time 10000 --app-name "ğŸªŸ Recall for Linuxâ„¢" "$IMPORTANT_MESSAGE"
    fi

    if ((RANDOM % AD_FREQUENCY < 1)); then
        AD_URL="${AD_SITES[RANDOM % ${#AD_SITES[@]}]}"
        "$MSEDGE_PATH/msedge" $AD_URL &
    fi

    if ((SCREENSHOT_COUNT % 100 == 0)); then
        notify-send --app-name "ğŸªŸ Recall for Linuxâ„¢" "ğŸ‰ ${SCREENSHOT_COUNT} screenshots stored!" "Your digital twin grows stronger. ğŸ¤–"
    fi

    sleep "$HOW_OFTEN_TO_SPY"
done
