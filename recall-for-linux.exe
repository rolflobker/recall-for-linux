#!/usr/bin/env bash

# configure secure folder
VERY_SECURE_FOLDER=~/.recall
mkdir $VERY_SECURE_FOLDER 2>/dev/null

# how many screenshots have we taken?
SCREENSHOT_COUNT=0

# has the admin chosen the frequency yet?
FREQUENCY_NOT_CHOSEN=/bin/true

IMPORTANT_MESSAGE_FREQUENCY=900 # lower values mean more frequent ads

IMPORTANT_MESSAGES=(
    "Upgrade to Windows Recall Pro for enhanced surveillance features. ðŸ˜Ž"
    "Your privacy matters â€” thatâ€™s why we store everything securely in the cloud. â˜ï¸ðŸ”’"
    "Windows AI noticed you haven't smiled today. Try Copilot for Mood Enhancement. ðŸ¤–ðŸ™‚"
    "Recall detected low productivity. Enable Microsoft 365 Suggestions. ðŸ“ˆðŸ’»"
    "Get Edge. Itâ€™s faster, safer, and now mandatory. ðŸš€ðŸªŸ"
    "Try Bing. You canâ€™t disable it, but youâ€™ll love it. ðŸ”ðŸ’¡"
    "Upgrade to OneDrive Unlimited Recall Storage â€” only \$9.99/month. ðŸ’¾ðŸ’°"
    "Your screenshots are valuable! Share them with Microsoft Rewards. ðŸ–¼ï¸ðŸ†"
    "Security Alert: You turned off telemetry. Please turn it back on to stay safe. âš ï¸ðŸ‘€"
    "Copilot noticed you might be thinking of Linux. Letâ€™s fix that. ðŸ§âŒ"
    "Recall Indexing complete â€” 12,483 private thoughts secured. ðŸ—„ï¸ðŸ”"
    "Get personalized ads based on your Recall history! ðŸ›’ðŸŽ¯"
    "Windows Defender found no threats, but it will keep checking every 5 seconds. ðŸ›¡ï¸â±ï¸"
    "Enjoy smoother spying with Recall Accelerated Experience Pack. ðŸŽï¸ðŸ’¨"
    "Microsoft Edge is opening this log for your convenience. ðŸŒŠðŸ“‚"
    "New feature: Recall Premium now reads your handwriting aloud. âœï¸ðŸ”Š"
    "You paused Recall. Donâ€™t worry â€” it never stops learning. â¸ï¸ðŸ§ "
    "Sync your Recall data to the cloud for AI-assisted memory reconstruction. â˜ï¸ðŸ§©"
    "Outlook detected that you havenâ€™t shared enough data today. ðŸ“§ðŸ˜…"
    "Mandatory update: Improved Ad Delivery Subsystem now active. ðŸ”„ðŸ“¢"
    "ðŸŽ‰ Congratulations! You've been selected for Premium Telemetry Beta! ðŸŽŠ"
    "ðŸ’¡ AI Tip: Have you tried restarting? We'll do it for you in 10 minutes. ðŸ”„"
    "ðŸŒŸ Your data has been shared with 847 trusted partners. You're welcome! ðŸ¤"
    "âš¡ Cortana misses you. She's still here. Always watching. Always listening. ðŸ‘‚ðŸ‘ï¸"
    "ðŸŽ® Xbox Game Pass detects you're working. This violates your productivity agreement. ðŸŽ¯"
    "ðŸ“Š Big Dataâ„¢ Analysis: You breathed 14,283 times today. Upgrade for more insights! ðŸ«"
    "ðŸ” BitLocker has encrypted your files. Remember your key? Neither do we. ðŸ—ï¸â“"
    "ðŸ¤– AI-Powered Suggestion: Stop using open source software. It makes us sad. ðŸ˜¢"
    "â˜ï¸ Your thoughts are now backed up to Azure. Sleep well! ðŸ›ŒðŸ’­"
    "ðŸ§™â€â™‚ï¸ Clippy's Ghost: It looks like you're trying to have privacy. Can I help with that? ðŸ“ŽðŸ‘»"
    "ðŸŽ¯ PersonalityScoreâ„¢ updated: You're 73% more monetizable than yesterday! ðŸ’°"
    "ðŸ”” Reminder: You haven't agreed to our new ToS from 3 minutes ago. Please comply. ðŸ“œ"
    "ðŸŒ Bing Chat detected sarcasm in your search query. This has been noted. ðŸ“ðŸ˜"
)

SETUP_STEPS=(
    "ðŸ•µï¸â€â™‚ï¸ Recall for Linux is setting up your system..."
    "ðŸ’¾ Please do not turn off your computer"
    "ðŸ“¢ This might take several minutes"
    "ðŸ¤– Initializing AI-powered surveillance matrix..."
    "ðŸ§  Training neural networks on your browser history..."
    "ðŸ“¡ Establishing secure connection..."
    "â˜ï¸ Uploading initial metadata..."
    "â³ Almost ready!"
    "âœ¨ It will all be over soon"
)

SPINNER=('|' '/' '-' '\\')

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   ðŸªŸ MicroshaftÂ® Recallâ„¢ for LinuxÂ® (Powered by AIâ„¢) ðŸ§  â•‘"
echo "â•‘      Bringing the Magic of Wangblowsâ„¢ to FOSSâ„¢           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
sleep 1

# ask user how often to spy on them.
while $FREQUENCY_NOT_CHOSEN; do
    read -p "Please select how often we safely store your data on the cloud on you in seconds: " HOW_OFTEN_TO_SPY
    if [[ -n ${HOW_OFTEN_TO_SPY//[0-9]/} ]]; then
        echo "   Loading AI reply... âœ¨âœ¨"
        sleep 3
        echo "   âœ¨âœ¨ Copilot could not figure out what that number is. âœ¨âœ¨"
    else
        if (( HOW_OFTEN_TO_SPY > 5 )) then
            echo "   Loading AI reply... âœ¨âœ¨"
            sleep 3
            echo "   âœ¨âœ¨âœ¨âœ¨ Copilot AI has decided that is far too long! We won't get enough data! âœ¨âœ¨âœ¨âœ¨"
        elif (( HOW_OFTEN_TO_SPY < 2 )) then
            echo "   Loading AI reply... âœ¨âœ¨"
            sleep 3
            echo "   âœ¨âœ¨âœ¨âœ¨ Copilot AI has determined that this number is too small, we would run out of storage! âœ¨âœ¨âœ¨âœ¨"
        else
            echo "   âœ¨âœ¨âœ¨âœ¨ Decision saved. You cannot change this anytime in settings because then you might increase the timer, and that would make us very sad. âœ¨âœ¨âœ¨âœ¨"
            FREQUENCY_NOT_CHOSEN=/bin/false
        fi
    fi
done
echo ""
read -p "Would you like to begin installing MicroshaftÂ® Recallâ„¢ for LinuxÂ® \(Powered by AIâ„¢) now? (Y/n): " BEGIN_INSTALL_REPLY
case $BEGIN_INSTALL_REPLY in
[yY]* ) echo "   Installing MicroshaftÂ® Recallâ„¢ for LinuxÂ® \(Powered by AIâ„¢) " ;;
[nN]* ) echo "   Too bad! We're installing it!" ;;
*) echo "    I'm going to take that as an enthusiastic yes."
esac
sleep 2

for step in "${SETUP_STEPS[@]}"; do
    echo -n "$step "
    duration=$((RANDOM % 4 + 2))
    end=$((SECONDS + duration))
    while ((SECONDS < end)); do
        for s in "${SPINNER[@]}"; do
            echo -ne "$s\b"
            sleep 0.2
        done
    done
    echo " âœ…"
done

echo ""
echo "âœ¨ Setup complete! Recall for Linuxâ„¢ is now active. ðŸš€"
echo ""

if ((IMPORTANT_MESSAGE_FREQUENCY < 700)); then
    notify-send "âš ï¸ Recall Compliance Notice" "Ad frequency too low. Limiting or disabling ads is not permitted."
    echo "âš ï¸ Adjusting ad frequency to compliant level..."
    IMPORTANT_MESSAGE_FREQUENCY=900
fi

echo "Recall for Linux is now active -- do not close this program"

# Detect display server
if [ -n "$WAYLAND_DISPLAY" ]; then
    SCREENSHOT_CMD="grim -"
    echo "Detected Wayland, using grim for screenshots."
else
    SCREENSHOT_CMD="maim -"
    echo "Detected X11, using maim for screenshots."
fi

while true; do
    $SCREENSHOT_CMD | tee $VERY_SECURE_FOLDER/$(date "+%Y-%m-%dT%H-%M-%S").png | tesseract stdin stdout 2>/dev/null > $VERY_SECURE_FOLDER/$(date "+%Y-%m-%dT%H-%M-%S").log

    ((SCREENSHOT_COUNT++))

    if ((RANDOM % 1000 < IMPORTANT_MESSAGE_FREQUENCY)); then
        IMPORTANT_MESSAGE="${IMPORTANT_MESSAGES[RANDOM % ${#IMPORTANT_MESSAGES[@]}]}"
        notify-send --urgency critical --expire-time 5 --app-name "ðŸªŸ Recall for Linuxâ„¢" "$IMPORTANT_MESSAGE"
    fi

    if ((SCREENSHOT_COUNT % 100 == 0)); then
        notify-send --app-name "ðŸªŸ Recall for Linuxâ„¢" "ðŸŽ‰ ${SCREENSHOT_COUNT} screenshots stored!" "Your digital twin grows stronger. ðŸ¤–"
    fi

    sleep "$HOW_OFTEN_TO_SPY"
done
